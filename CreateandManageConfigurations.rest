.. _CreateandManageConfigurations:

Create & Manage Configurations
================================

A configuration is the means by which an instrument is described and defined to IBEX.  A configuration defines the blocks, IOCs, components, macros and other items which IBEX needs to use in order to control the instrument.  You can create multiple configurations for an instrument, to describe and define how the instrument has been set up for different experiments.

**Please note:** An IBEX configuration is **not** the same as a Mantid configuration.  IBEX and Mantid view instruments in fundamentally different ways, which means that their respective configurations are not interchangeable.

Contents
--------

#. `Creating a Configuration`_

   #. `IOCs Tab`_
   #. `Blocks Tab`_
   #. `Groups Tab`_
   #. `Components Tab`_
   #. `IOC Macros`_
   #. `IOC PV Values`_
   #. `IOC PV Sets`_
   #. `Summary`_

#. `Editing a Configuration`_
#. `Edit Current Configuration ...`_
#. `Load a Configuration`_
#. `Delete a Configuration`_

Creating a Configuration
------------------------

To create a configuration:

#. Select ``Configurations > New`` from the ``Configuration`` menu.
#. IBEX displays the Edit Configuration dialog, which contains eight tabs.  

   #. IOCs
   #. Blocks
   #. Groups
   #. Components
   #. IOC Macros
   #. IOC PV Values
   #. IOC PV Sets
   #. Summary

#. At the bottom of the dialog are two buttons

Save as...
   Click on the ``Save as...`` button to save your changes.  The Save as... dialog prompts you to provide a name and description for your configuration.

   * You must provide a name for the configuration.
   * The name of the configuration can contain only the characters a-z, A-Z, 0-9 and _ (underscore).
   * The name must also start with a character.
   * The name of the configuration must be unique (on your instrument).

   The Save as... dialog also includes an option to save a configuration as a component.  This option is described in more detail in the [[CreateandManageComponents]] page.

Cancel
   Click on the ``Cancel`` button to exit the Edit Configuration dialog without saving your changes.

We'll describe each of the Edit Configuration dialog tabs in turn.

IOCs Tab
~~~~~~~~
The IOCs tab lists all the IOCs available on the instrument.  In general, you will only wish to include a sub-set of these in your configuration (i.e. those that correspond to devices on your instrument).

The [[KeyConceptsinIBEX]] page describes what an IOC is.

To include an IOC in your configuration, scroll down the list until you find the appropriate IOC and select the Auto-Start or Auto-Restart check-boxes (or select both).  By selecting these check-boxes, IBEX will automatically start (or restart) to chosen IOCs each time your configuration is loaded into IBEX.

**Note:** The list of IOCs in the IOC tab also includes a column headed Sim. level.  This column is used to indicate whether the IOC should run in simulation mode.  By default, the Sim. level file is set to NONE, meaning that the IOC will not run in simulation mode.  Under normal circumstances, you should not change the default setting.

Blocks Tab
~~~~~~~~~~
The Blocks tab lists all the blocks that have been defined for the current configuration.  When creating a new configuration, the list of blocks will be empty.  A block is, essentially, an alias to a PV ([[ProcessVariables]]).

To create a new block, click on the ``Add Block`` button.  IBEX displays a dialog to allow you to define the new block.  By default, the new block is given the name ``NEW_BLOCK``.  You can give the block any name you like, provided the name 

* contains only the characters a-z, A-Z, 0-9 and _ (underscore).
* starts with a character.
* is unique (on your instrument).

Below the block name field is the PV address field.  Click on the ``Select PV`` button next to the PV address field to choose a PV to be aliased by the block name.

On clicking the ``Select PV`` button, IBEX will display a list of PVs available on your instrument.  There can be a very large number of PVs on an instrument, so the dialog provides a number of filters to help you narrow your search.  Choose:

PVs from
   ``All IOCs`` to see PVs from all IOCs on your instrument (this can result in a very long list of PVs).

   ``Active IOCs`` to see PVs only from IOcs that are currently running on your instrument.

   ``Config IOCs`` to see PVs only from IOCs that are included in the current configuration.

Interest Level
   ``High`` to see PVs considered to be of high interest to scientists

   ``Medium`` to see PVs considered to be of medium interest to scientists (many PVs in this category will be of more interest to technicians and support staff, rather than scientists)

   ``Facility`` to see PVs that relate to facility, rather than instrument, devices (PVs in this category typically include PVs relating to the accelerator, target stations, shared beamlines and instrument shutters).

   ``All`` to see all PVs from your selected category of IOCs (again, this can generate a very long list of PVs).

You can also narrow down the list of PVs by typing the start of the PV name in the ``PV address`` field.  For example, if you type ``IN:IRIS:EURO`` you will see only PVs whose address starts with those characters.  This is useful if you already know which PV you are looking for.

Scroll down the list of PVs until you find the one you want.  Click on it, to select it and then click on the OK button to return to the Add Block dialog.

On the Add Block dialog you can also choose to 

Visible/Local
   Toggle the ``Visible`` check-box to make the block visible or hidden.  By default, blocks are always visible.  This feature is useful, for example, if you need to see blocks while setting up an experiment, but don't need to see them once the experiment is running.

   The ``Local`` check-box is used when you need to view PVs from another instrument as blocks.  In most circumstances, you will not need to view PVs belonging to another instrument, so you should leave the ``Local`` check-box checked.  Facility PVs are an exception to this rule, but IBEX knows about facility PVs and, in this case, automatically sets the ``Local`` check-box  to unchecked.  If you do need to view PVs belonging another instrument, please consult with the Experiment Controls team.

Run-Control Settings
   Toggle the ``Enabled`` check-box to enable run-control on this block.  Use the Low Limit and High Limit fields to define the run-control range (i.e. data is collected only when the block lies within the range) .

Logging Settings
   Use the Logging Settings section of the Configure Block dialog to control how the value of the block is logged.

   * **Note:** By default logging is disabled (i.e. changes in the value of the block will not be logged).  
   * Click on the ``Enabled`` check-box to change the way the block is logged.  If the ``Enabled`` check-box is checked, then logging is enabled.
   * You can choose to log the block value periodically (the default period is every 30 seconds).
   * Alternatively, you can set a "deadband" - the block will only be logged if its value falls outside +/- the limit defined by the deadband value.

**Note:** Blocks that have been inherited from component will be shown, but cannot be cannot be modified, in the Edit Configuration dialog (the blocks will be shown as "greyed-out").  To modify inherited blocks you need to use the Edit Component dialog (see [[CreateandManageComponents]]).

Groups Tab
~~~~~~~~~~
Use the Groups tab to arrange your blocks into convenient groups.  You can define as many groups as you wish and you can place as many blocks in each group as you wish, although a block can only appear in one group.

By default, all blocks are assigned to an automatic group called "Other".  By creating new groups, you have the opportunity to override the default assignment and assign blocks to groups of your choosing.  

To create a new group, select the Groups tab and click on the ``Add`` button.  IBEX displays a dialog to allow you to define a new group.  By default, the new group is given the name ``NEW_GROUP``.  You can give the group any name you like, provided the name 

* contains only the characters a-z, A-Z, 0-9 and _ (underscore).
* starts with a character.
* is unique (on your instrument).

When you click on the ``Add`` button, the dialog displays which blocks are available to be assigned to the new group (i.e. blocks in the "Other" group).

Use the buttons with the Up and Down arrows to control the ordering of the groups and the order of the blocks within the groups.

You can select multiple blocks to be added (or removed) from a group using the ``Shift`` and/or Ctrl`` keys on your keyboard.

**Note:** Groups that have been inherited from component will be shown, but cannot be cannot be modified, in the Edit Configuration dialog (the blocks in an inherited group as shown as "greyed-out").  To modify inherited groups you need to use the Edit Component dialog (see [[CreateandManageComponents]]).

Components Tab
~~~~~~~~~~~~~~

Components are, in essence, mini configurations.  You can use components to "pre-configure" a device (or group of devices) and then include the components in a configuration. The process of creating and managing components is described in [[CreateandManageComponents]].

The Components tab displays two lists of components.  The left hand list shows which components are available to be included in your configuration.  The right hand list shows which components are already included in your configuration.   You can only include a component once in a configuration.

Use the arrow buttons to move components between the two lists.  

IOC Macros
~~~~~~~~~~

IOC Macros are configurable values that IBEX can supply to the IOC when the IOC is started.  For example, if the IOC is controlling a serial device attached to a COM port, you can use an macro to identify the appropriate port to the IOC.  This is especially useful if the device moves between instruments and may be attached to different COM ports on different instruments.  Another example of an IOC macro might be the name of a calibration file.

To set an IOC macro:

#. Select the IOC Macros tab and choose an IOC from the drop-down menu list of IOCs.  If the IOC has any configurable macro parameters, they will be displayed in the table below.  The table contains four columns:

   #. Macro Name: the name of the macro (e.g. ``PORT``, ``BAUD`` or ``IPADDRESS``)
   #. Value: the current value of the macro (e.g. ``COM3``, ``9600`` or ``192.83.42.106``)
   #. Description: a short description of the macro's purpose
   #. Pattern: macro values need to be defined correctly.  IBEX uses the pattern to validate the macro value. (For those familiar with such things, the pattern is expressed as a "regular expression").

#. Choose a macro from the table.  The ``Name:`` field (read-only) is populated with the macro name and the ``Value:`` field is populated with the current value of the macro.

#. Edit the ``Value:`` field to change the macro value.  Please note that the value you enter will be validated against the pattern.  If the macro does not conform to the pattern, IBEX will display a warning message.  IBEX will refuse to accept any values that do not conform to the pattern.

#. Click on the ``Set Macro`` button to set the macro value.  The table of macros will be updated with the new value.  You can also use the ``Clear Macro`` button to clear the contents of the ``Value:`` field.

If you are not sure about how to correctly configure macro values for a device, please consult with the Experimental Controls team.

IOC PV Values
~~~~~~~~~~~~~

**TO DO**

IOC PV Sets
~~~~~~~~~~~

**TO DO**

Summary
~~~~~~~

The Summary tab allows you to create a short description for your configuration.  It also allows you to associate a default synoptic view with your configuration.

When you click on the Summary tab, IBEX displays the following fields:

Name
   This is a read-only field.  It is defined when you save the configuration.  When you are creating a new configuration, the ``Name:`` field will be empty.

Description
   Provide a short description of your configuration.  Configuration names can sometime be a little cryptic; a short description will help you to better remember the purpose of the configuration.

Synoptic
   IBEX allows you to create different synoptic views for use with different configurations.  Therefore, it is convenient to associate a synoptic view with a configuration - it saves you from having to remember the association.  Your chosen synoptic will be used as the default synoptic whenever you use this configuration.  

Editing a Configuration
-----------------------

To edit a configuration:

#. Select ``Configurations > Edit`` from the ``Configuration`` menu.
#. IBEX displays the Edit Configuration dialog (as described in `Creating a Configuration`_).
#. This time the Edit Configuration dialog has three buttons at the bottom of the dialog

Save
   Clicking on the ``Save`` button immediately saves your changes without any further prompting.  

Save as...
   Clicking on the ``Save as...`` button operates as described in the previous section.  You can use the ``Save as...`` button to save the configuration with a new name, prior to making further changes.

Cancel
   Click on the ``Cancel`` button to exit the Edit Configuration dialog without saving your changes. 

Edit Current Configuration ...
------------------------------

To edit the current configuration simply select ``Edit Current Configuration ...`` from the ``Configuration`` menu.  This avoids the need to select the current configuration from a list of configurations.  Otherwise, this option behaves in the same way as `Editing a Configuration`_.

**Note:** When you click on the ``Save`` button when editing the current configuration, the changes you make are applied immediately.  There will be a short pause while IBEX re-loads the current configuration and refreshes the display.

Load a Configuration
--------------------

To load a configuration:

#. Select ``Configurations > Load`` from the ``Configuration`` menu.
#. IBEX displays the Load Configuration dialog, which list all the configurations defined for your instrument.
#. Select a configuration from the list and press the ``OK`` button
#. IBEX discards the currently loaded configuration and loads the selected configuration.  The discarded configuration is not lost - it still exists as a saved configuration and can be re-loaded later, if you wish.

Delete a Configuration
----------------------

To delete a configuration:

#. Select ``Configurations > Delete`` from the ``Configuration`` menu.
#. IBEX displays the Delete Configuration dialog, which lists all the configurations defined for your instrument.
#. Select a configuration from the list and press the ``OK`` button
#. IBEX deletes the selected configuration.

**Note 1:** If you try to delete the currently loaded configuration, IBEX will do nothing.  It will not delete the current configuration, because that would leave IBEX unable to communicate with the instrument.  If you want to delete the current configuration, load a different configuration, then delete the previously loaded configuration.

**Note 2:** When you delete a configuration it really is deleted.  It is no longer available to be used by IBEX. Before deleting a configuration, please be sure that you really do want to delete it.  If you unintentionally delete a configuration, please contact the Experimental Controls team - it may be possible to recover the deleted configuration.